all: check

GREP-version: ; @grep --version | grep "GNU grep" > /dev/null
FIND-version: ; @find --version | grep "GNU findutils" > /dev/null

ROOT_DIR := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

check: GREP-version FIND-version

install: check
	ln -sf $(ROOT_DIR)/detect-exploits.sh /usr/local/bin/detect-exploits

dev-install: test/wordpress wordpress /usr/local/bin/bats

/usr/local/bin/bats:
	git clone https://github.com/sstephenson/bats.git
	cd bats && sudo ./install.sh /usr/local

test/wordpress:
	wget https://wordpress.org/latest.tar.gz -O test/latest.tar.gz
	cd test; tar -xzf latest.tar.gz; rm latest.tar.gz;

wordpress:
	find test/wordpress -type d -exec chmod 0755 "{}" \;
	find test/wordpress -type f -exec chmod 0644 "{}" \;
	cp test/wordpress/wp-config-sample.php test/wordpress/wp-config.php
	chmod 644 test/wordpress/wp-config.php

test:
	bats test/*.bats --tap

.PHONY: test
