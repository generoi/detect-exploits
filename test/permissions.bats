#!/usr/bin/env bats

load test_helpers

setup() {
  umask 022

  mkdir -p $dir/wp-content/{uploads,files_mf}
  chmod 2775 $dir/wp-content/{uploads,files_mf}

  chmod o+w $dir/wp-blog-header.php
  chmod o+w $dir/wp-admin

  touch -f $dir/wp-content/uploads/bar.txt
  chmod o+w $dir/wp-content/uploads/bar.txt

  chmod o+w $dir/wp-content/uploads

  touch -f $dir/wp-content/uploads/.htaccess
  chmod o+w $dir/wp-content/uploads/.htaccess
}

teardown() {
  chmod o-w $dir/wp-blog-header.php
  chmod o-w $dir/wp-admin
  rm -f $dir/wp-content/uploads/bar.txt
  rm -f $dir/wp-content/uploads/.htaccess
  rm -rf $dir/wp-content/{uploads,files_mf}
}

@test "is able to scan permissions" {
  run bash ./detect-exploits.sh --scan-permissions --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-blog-header.php"* ]]
  [[ "$output" == *"$dir/wp-admin"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/bar.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/.htaccess"* ]]
  [[ "$output" == *"5 alerts found"* ]]
}
