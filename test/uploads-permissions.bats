#!/usr/bin/env bats

load test_helpers

setup() {
  umask 022

  mkdir -p $dir/wp-content/uploads
  mkdir -p $dir/wp-content/files_mf
  chmod 2775 $dir/wp-content/uploads
  chmod 2775 $dir/wp-content/files_mf

  touch -f $dir/wp-content/uploads/foo.txt
  touch -f $dir/wp-content/uploads/bar.txt
  touch -f $dir/wp-content/uploads/baz.txt
  touch -f $dir/wp-content/uploads/noorf.txt
  touch -f $dir/wp-content/uploads/qux.txt
  touch -f $dir/wp-content/uploads/.htaccess
  touch -f $dir/wp-content/files_mf/.htaccess

  # Permissions checks
  chmod o+w $dir/wp-content/uploads # not ok
  chmod g+x $dir/wp-content/uploads/foo.txt # not ok
  chmod o+w $dir/wp-content/uploads/bar.txt # not ok
  chmod 600 $dir/wp-content/uploads/baz.txt # ok
  chmod 660 $dir/wp-content/uploads/noorf.txt # ok
  chmod 664 $dir/wp-content/uploads/qux.txt # ok

  # htaccess checks
  chmod u+w $dir/wp-content/uploads/.htaccess # not ok
  chmod 444 $dir/wp-content/files_mf/.htaccess # ok
}

teardown() {
  rm -f $dir/wp-content/uploads/foo.txt
  rm -f $dir/wp-content/uploads/bar.txt
  rm -f $dir/wp-content/uploads/baz.txt
  rm -f $dir/wp-content/uploads/noorf.txt
  rm -f $dir/wp-content/uploads/qux.txt
  rm -f $dir/wp-content/uploads/.htaccess
  rm -f $dir/wp-content/files_mf/.htaccess
  rm -rf $dir/wp-content/uploads
  rm -rf $dir/wp-content/files_mf
}

@test "is able to scan uploads permissions" {
  run bash ./detect-exploits.sh --scan-upload-permissions --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/uploads/foo.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/bar.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/.htaccess"* ]]
  [[ "$output" == *"4 alerts found"* ]]
}

@test "is able to scan uploads ownership permissions" {
  run bash ./detect-exploits.sh --owner=nobody --group=nobody --scan-upload-permissions --web-group=nobody "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/uploads/foo.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/bar.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/baz.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/noorf.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/qux.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/.htaccess"* ]]
  [[ "$output" == *"$dir/wp-content/files_mf/.htaccess"* ]]
}
