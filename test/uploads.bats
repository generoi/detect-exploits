#!/usr/bin/env bats

load test_helpers

setup() {
  umask 022
  mkdir -p $dir/wp-content/{uploads,files_mf}
  echo "" >| $dir/wp-content/uploads/foo.inc
  echo "" >| $dir/wp-content/uploads/bar.inc
  echo "" >| $dir/wp-content/files_mf/wp-config.php

}

teardown() {
  rm -f $dir/wp-content/uploads/foo.inc
  rm -f $dir/wp-content/uploads/bar.inc
  rm -f $dir/wp-content/files_mf/wp-config.php
  rm -rf $dir/wp-content/{uploads,files_mf}
}

@test "is able to scan uploads" {
  run bash ./detect-exploits.sh --scan-uploads -v --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/uploads/foo.inc"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/bar.inc"* ]]
  [[ "$output" == *"$dir/wp-content/files_mf/wp-config.php"* ]]
  [[ "$output" == *"skipping uploads directory: $dir/wp-content/blogs.dir"* ]]
  [[ "$output" == *"3 alerts found"* ]]
}
