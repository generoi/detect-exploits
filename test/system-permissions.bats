#!/usr/bin/env bats

load test_helpers

setup() {
  umask 022

  chmod o+w $dir/wp-blog-header.php
  chmod o+w $dir/wp-admin

  # Dummy to make sure check doesnt descend into uploads
  mkdir -p $dir/wp-content/uploads
  chmod 2775 $dir/wp-content/uploads
  touch -f $dir/wp-content/uploads/foo.txt
  chmod 777 $dir/wp-content/uploads/foo.txt
}

teardown() {
  chmod o-w $dir/wp-blog-header.php
  chmod o-w $dir/wp-admin
  rm -f $dir/wp-content/uploads/foo.txt
  rm -rf $dir/wp-content/uploads
}

@test "is able to scan system permissions" {
  run bash ./detect-exploits.sh --scan-permissions -v --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-blog-header.php"* ]]
  [[ "$output" == *"$dir/wp-admin"* ]]
  [[ "$output" == *"2 alerts found"* ]]
}

@test "is able to scan system ownership permissions" {
  run bash ./detect-exploits.sh --scan-permissions --owner=nobody --group=nobody --web-group=nobody "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-blog-header.php"* ]]
  [[ "$output" == *"$dir/wp-admin"* ]]
}
