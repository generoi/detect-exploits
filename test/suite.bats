#!/usr/bin/env bats

load test_helpers

@test "is able to scan for keywords" {
  run bash ./detect-exploits.sh --scan-keywords --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/foo.php:1:r0nin"* ]]
  [[ "$output" == *"$dir/wp-content/eval.php:1:eval (base64_decode('xxx'))"* ]]
  [[ "$output" == *"$dir/wp-cron.php:"* ]]
  [[ "$output" == *"$dir/wp-content/line.php:1:======="* ]]
  [[ "$output" == *"$dir/wp-content/whitespace.php:1"* ]]
  [[ "$output" == *"5 alerts found"* ]]
}

@test "is able to scan uploads" {
  run bash ./detect-exploits.sh --scan-uploads -v --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/uploads/foo.inc"* ]]
  [[ "$output" == *"$dir/wp-content/files_mf/wp-config.php"* ]]
  [[ "$output" == *"skipping uploads directory: $dir/wp-content/blogs.dir"* ]]
  [[ "$output" == *"2 alerts found"* ]]
}

@test "is able to scan duplicates" {
  run bash ./detect-exploits.sh --scan-duplicates --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/files_mf/wp-config.php"* ]]
  [[ "$output" == *"1 alerts found"* ]]
}

@test "is able to scan filenames" {
  run bash ./detect-exploits.sh --scan-filenames --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/_old.php"* ]]
  [[ "$output" == *"1 alerts found"* ]]
}

@test "is able to scan permissions" {
  run bash ./detect-exploits.sh --scan-permissions --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-blog-header.php"* ]]
  [[ "$output" == *"$dir/wp-admin"* ]]
  #[[ "$output" == *"$dir/wp-content/uploads/foo.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/bar.txt"* ]]
  [[ "$output" == *"$dir/wp-content/uploads"* ]]
  [[ "$output" == *"$dir/wp-content/uploads/.htaccess"* ]]
  [[ "$output" == *"5 alerts found"* ]]
}
