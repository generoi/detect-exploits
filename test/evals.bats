#!/usr/bin/env bats

load test_helpers

setup() {
  umask 022
  echo "eval/*;*/ (base64_decode('xxx'))" >| $dir/wp-content/eval.php
  echo "eval();print()" >| $dir/wp-content/valid_eval.php
  echo -e "eval (base64_decode('cron'))" >> $dir/wp-cron.php
}

teardown() {
  rm -f $dir/wp-content/eval.php
  rm -f $dir/wp-content/valid_eval.php
  sed -i '$ d' $dir/wp-cron.php
}

@test "is able to scan for evals" {
  run bash ./detect-exploits.sh -v --scan-evals "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 1 ]
  [[ "$output" == *"$dir/wp-content/eval.php:1:eval/*;*/ (base64_decode('xxx'))"* ]]
  [[ "$output" == *"$dir/wp-cron.php:"* ]]
  [[ "$output" == *"2 alerts found"* ]]
}
