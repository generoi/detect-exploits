#!/usr/bin/env bats

load test_helpers

setup() {
  mkdir -p $dir/wp-content/uploads
}
teardown() {
  rm -rf $dir/wp-content/uploads
}

@test "--scan-keywords" {
  run bash ./detect-exploits.sh -v --scan-keywords --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" == *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-whitespaces" {
  run bash ./detect-exploits.sh -v --scan-whitespaces --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" == *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-evals" {
  run bash ./detect-exploits.sh -v --scan-evals --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" == *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-longlines" {
  run bash ./detect-exploits.sh -v --scan-longlines --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" == *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-uploads" {
  run bash ./detect-exploits.sh -v --scan-uploads --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" == *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-filenames" {
  run bash ./detect-exploits.sh -v --scan-filenames --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" == *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-duplicates" {
  run bash ./detect-exploits.sh -v --scan-duplicates --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" == *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" != *"running permissions scan"* ]]
}
@test "--scan-permissions" {
  run bash ./detect-exploits.sh -v --scan-permissions --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" != *"running keyword scan"* ]]
  [[ "$output" != *"running duplication scan"* ]]
  [[ "$output" != *"running eval scan"* ]]
  [[ "$output" != *"running long lines scan"* ]]
  [[ "$output" != *"running long whitespace scan"* ]]
  [[ "$output" != *"running filename scan"* ]]
  [[ "$output" != *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" == *"running permissions scan"* ]]
}
@test "--scan-all" {
  run bash ./detect-exploits.sh --scan-all -v --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" == *"running keyword scan"* ]]
  [[ "$output" == *"running duplication scan"* ]]
  [[ "$output" == *"running eval scan"* ]]
  [[ "$output" == *"running long lines scan"* ]]
  [[ "$output" == *"running long whitespace scan"* ]]
  [[ "$output" == *"running filename scan"* ]]
  [[ "$output" == *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" == *"running permissions scan"* ]]
}
@test "scan-all by default" {
  run bash ./detect-exploits.sh -v --web-group="$user_group" "$dir"
  printf '%b\n' "$output"
  [ "$status" -eq 0 ]
  [[ "$output" == *"running keyword scan"* ]]
  [[ "$output" == *"running duplication scan"* ]]
  [[ "$output" == *"running eval scan"* ]]
  [[ "$output" == *"running long lines scan"* ]]
  [[ "$output" == *"running long whitespace scan"* ]]
  [[ "$output" == *"running filename scan"* ]]
  [[ "$output" == *"running suspicious files scan in uploads directory"* ]]
  [[ "$output" == *"running permissions scan"* ]]
}
